<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solitaire</title>
<style>
body { font-family: Arial; text-align:center; background:#0b6623; color:white; }
button { padding:10px 20px; margin:5px; }
#lb-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.8);
  display:none; align-items:center; justify-content:center;
}
#lb-overlay.show { display:flex; }
#lb-box {
  background:#111; padding:20px; border-radius:10px;
  width:400px; max-height:80vh; overflow:auto;
}
.lb-row { display:flex; justify-content:space-between; margin:5px 0; }
</style>
</head>
<body>

<h1>Solitaire</h1>
<button onclick="showLeaderboard()">Leaderboard</button>

<div id="lb-overlay">
  <div id="lb-box">
    <h2>Leaderboard</h2>
    <ul id="lb-list" style="list-style:none;padding:0;"></ul>
    <button onclick="hideLeaderboard()">Close</button>
  </div>
</div>

<script>
let playerName = null;

/* ---------- NAME STORAGE ---------- */

function initPlayer() {
  const saved = localStorage.getItem('solitaire:name');
  if (saved) {
    playerName = saved;
  } else {
    const name = prompt("Enter your name:");
    if (name) {
      playerName = name.trim().slice(0,20);
      localStorage.setItem('solitaire:name', playerName);
    }
  }
}

initPlayer();

/* ---------- LEADERBOARD (SERVER VERSION) ---------- */

async function submitScore(secs) {
  if (!playerName) return;

  try {
    await fetch('/api/leaderboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: playerName,
        time: secs
      })
    });
  } catch (err) {
    console.error('Failed to submit score:', err);
  }
}

async function showLeaderboard() {
  document.getElementById('lb-overlay').classList.add('show');
  const list = document.getElementById('lb-list');
  list.innerHTML = 'Loading...';

  try {
    const res = await fetch('/api/leaderboard');
    const board = await res.json();

    list.innerHTML = '';

    if (!board.length) {
      list.innerHTML = '<li>No scores yet.</li>';
      return;
    }

    board.forEach((entry, i) => {
      const li = document.createElement('li');
      li.className = 'lb-row';
      li.innerHTML = `
        <span>#${i+1}</span>
        <span>${esc(entry.name)}</span>
        <span>${fmtTime(entry.time)}</span>
      `;
      list.appendChild(li);
    });

  } catch (err) {
    list.innerHTML = '<li>Error loading leaderboard</li>';
    console.error(err);
  }
}

function hideLeaderboard() {
  document.getElementById('lb-overlay').classList.remove('show');
}

function esc(s) {
  return s.replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');
}

function fmtTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return m + ":" + (s < 10 ? "0"+s : s);
}

/* ---------- EXAMPLE WIN TRIGGER ---------- */
/* Call submitScore(seconds) when player wins */

function fakeWin() {
  const randomTime = Math.floor(Math.random() * 300);
  submitScore(randomTime);
  alert("Score submitted: " + fmtTime(randomTime));
}
</script>

<br>
<button onclick="fakeWin()">Simulate Win</button>

</body>
</html>